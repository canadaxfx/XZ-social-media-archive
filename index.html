<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noai, noimageai" />
    <meta
      name="copyright"
      content="Content curation and organization ¬© 2025 CanadaXFX. Unauthorized AI training prohibited."
    />
    <title>Xiao Zhan Social Media Archive | ËÇñÊàòÁ§æ‰∫§Â™í‰ΩìÂ≠òÊ°£</title>
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-K5K952VW21"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-K5K952VW21");
    </script>

    <style>
            /* --- CORE STYLES --- */
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }
            body {
              font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
              background: linear-gradient(135deg, #1F2937 0%, #2D3748 100%);
              min-height: 100vh;
              color: #333;
            }
            .container {
              max-width: 1200px;
              margin: 0 auto;
              padding: 20px;
            }
            header {
              text-align: center;
              padding: 16px 0;
              color: white;
            }
            h1 {
              font-size: 1.3rem;
              margin-bottom: 10px;
              text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }
            .subtitle {
              font-size: 0.8rem;
              opacity: 1;
            }

            /* Navigation Buttons (Main Tabs) */
            .nav-buttons {
              display: flex;
              justify-content: center;
              gap: 15px;
              margin: 10px 0 12px;
            }
            .nav-btn,
            .btn {
              padding: 15px 15px;
              border: none;
              border-radius: 25px;
              cursor: pointer;
              font-size: 13px;
              font-weight: 600;
              transition: all 0.3s ease;
              text-decoration: none;
              display: inline-block;
            }
            .nav-btn.active,
            .btn.primary {
              background: linear-gradient(45deg, #5E9FD8, #4A8BC8);
              color: white;
              transform: translateY(-2px);
              box-shadow: 0 8px 20px rgba(94, 159, 216, 0.3);
            }
            .nav-btn:not(.active) {
              background: rgba(94, 159, 216, 0.15);
              color: white;
              backdrop-filter: blur(10px);
            }
            .nav-btn:hover {
              transform: translateY(-2px);
              box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            }

            /* Source Filter Bar (New) */
      .source-filters {
        display: flex;

        /* DEFAULT (Mobile): Allow wrapping if screen is tiny */
        flex-wrap: wrap;

        justify-content: center;
        align-items: center;
        gap: 8px;

        /* THE BOX / FRAME STYLING */
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(8px);
        border-radius: 20px;
        padding: 8px 15px;
        margin: 0 auto 20px;

        max-width: 95%;
        width: fit-content;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }

      /* NEW: Style for the "Filter:" label */
      .filter-label {
        color: rgba(255, 255, 255, 0.9);
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        margin-right: 5px;
        letter-spacing: 0.5px;
        display: inline-block;
      }

           .source-pill {
              padding: 6px 12px;
              border-radius: 15px;
              font-size: 12px;
              font-weight: 600;
              cursor: pointer;
              background: rgba(255, 255, 255, 0.15);
              color: white;
              border: 1px solid rgba(255, 255, 255, 0.3);
              transition: all 0.2s;
      	text-align: center;
              line-height: 1.3;
      	display: flex;
        	align-items: center;
        	justify-content: center;
        	text-align: center;
        	min-width: 80px;
            }

            .source-pill:hover {
              background: rgba(255, 255, 255, 0.3);
            }
            .source-pill.active {
              background: white;
              color: #5E9FD8;
              border-color: white;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

      /* --- DATE FILTER STYLES --- */
      .date-filter-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .date-select-wrapper {
        display: flex;
        gap: 8px;
        background: white;
        padding: 5px;
        border-radius: 25px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      }

      .date-select-wrapper select {
        border: none;
        background: transparent;
        padding: 8px 12px;
        font-size: 13px;
        font-weight: 600;
        color: #555;
        cursor: pointer;
        outline: none;
        border-radius: 20px;
      }

      .date-select-wrapper select:hover {
        background-color: #f0f2f5;
      }

      .reset-date-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: none;
        background: #5E9FD8;
        color: white;
        cursor: pointer;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
      }

      .reset-date-btn:hover {
        transform: scale(1.1);
      }

      /* Mobile Adjustment */
      @media (max-width: 480px) {
        .date-select-wrapper select {
          padding: 8px 4px;
          font-size: 12px;
        }
      }




            /* Content Sections */
            .content-section {
              background: rgba(255, 255, 255, 0.95);
              border-radius: 20px;
              padding: 15px;
              box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
              backdrop-filter: blur(10px);
            }
            .hidden {
              display: none !important;
            }

            /* Search */
            .search-bar {
              width: 100%;
              max-width: 400px;
              padding: 15px;
              border: 2px solid #e0e0e0;
              border-radius: 25px;
              font-size: 14px;
              margin: 0 auto 20px;
              display: block;
              transition: border-color 0.3s ease;
            }
            .search-bar:focus {
              outline: none;
              border-color: #5E9FD8;
            }

            /* Stats Grid */
            .stats-grid {
              display: flex;
              justify-content: center;
              gap: 15px;
              flex-wrap: wrap;
              max-width: 740px;
              margin: 0 auto 15px;
            }

            .stat-card {
              background: linear-gradient(135deg, #5E9FD8 0%, #4A8BC8 100%);
              color: white;
              padding: 10px 12px;
              border-radius: 15px;
              text-align: center;
              box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
              min-width: 110px;
              flex: 1;
              max-width: 200px;
            }
            .stat-number {
              font-size: 0.75rem;
              font-weight: bold;
              margin-bottom: 0px;
            }
            .stat-label {
              font-size: 12px;
              opacity: 0.9;
            }

            /* Timeline Styles */
            .timeline-container {
              max-width: 1000px;
              margin: 0 auto;
            }
            .timeline-year {
              margin-bottom: 20px;
              border: 1px solid #e0e0e0;
              border-radius: 15px;
              overflow: hidden;
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
              background: white;
            }
            .timeline-year-header {
              background: linear-gradient(45deg, #5E9FD8, #4A8BC8);
              color: white;
              padding: 15px 20px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              transition: all 0.3s ease;
              user-select: none;
              position: relative;
            }
            .timeline-year-header::after {
              content: "Click thumbnails for high-res ‚Ä¢ ÁÇπÂáªÁº©Áï•ÂõæÊâìÂºÄÈ´òÊ∏ÖÂõæ";
              position: absolute;
              bottom: 5px;
              left: 20px;
              font-size: 11px;
              opacity: 0.8;
              font-weight: normal;
              font-style: italic;
            }
            .timeline-year-header:hover {
              background: linear-gradient(45deg, #2D3748, #374151);
              transform: translateY(-1px);
            }
            .year-header-content {
              width: 100%;
            }
            .year-header-top {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            }
            .year-title {
              font-size: 16px;
              font-weight: bold;
            }
            .year-preview {
              display: flex;
              gap: 6px;
              align-items: center;
              margin-top: 8px;
              opacity: 0.9;
            }
            .timeline-year.expanded .year-preview {
              display: none;
            }
            .preview-thumb {
              width: 32px;
              height: 32px;
              object-fit: cover;
              border-radius: 6px;
              border: 2px solid rgba(255, 255, 255, 0.3);
              transition: all 0.3s ease;
            }
            .timeline-year-count {
              font-size: 14px;
              opacity: 0.9;
              background: rgba(255, 255, 255, 0.2);
              padding: 5px 12px;
              border-radius: 20px;
            }
            .expand-icon {
              font-size: 12px;
              transition: transform 0.3s ease;
              margin-left: 10px;
            }
            .timeline-year.expanded .expand-icon {
              transform: rotate(180deg);
            }
            .timeline-year-content {
              padding: 20px;
              background: white;
              display: none;
            }
            .timeline-year.expanded .timeline-year-content {
              display: block;
            }

            .year-controls {
                display: flex;
                justify-content: flex-end;
                align-items: center;
                margin-bottom: 10px;
                gap: 10px;
                padding: 0 0px;
            }
            .year-controls label {
                font-size: 13px;
                font-weight: 600;
                color: #555;
            }
            .year-controls select {
                padding: 6px 6px;
                border-radius: 8px;
                border: 1px solid #ccc;
                background-color: #f8f9fa;
                font-size: 13px;
                cursor: pointer;
            }

      /* --- NEW VIDEO INDICATOR STYLES --- */
      .video-overlay-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%); /* Centers the element */
        width: 46px;
        height: 46px;
        background: rgba(0, 0, 0, 0.6);   /* Semi-transparent dark background */
        border: 2px solid rgba(255, 255, 255, 0.9); /* Bright white border ring */
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        z-index: 5;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); /* Drop shadow for depth */
        pointer-events: none; /* Allows click to pass through to the photo */
        transition: all 0.3s ease;
        padding-left: 4px; /* Optical adjustment to center the triangle */
      }

      /* Hover Effect: Expands slightly and gets darker when user hovers the photo */
      .timeline-photo:hover .video-overlay-icon {
        transform: translate(-50%, -50%) scale(1.1);
        background: rgba(0, 0, 0, 0.8);
        border-color: #fff;
      }



            /* Photo Grid */
            .year-photos-grid {
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
              gap: 12px;
              margin-bottom: 15px;
            }
            .timeline-photo {
              aspect-ratio: 1;
              border-radius: 10px;
              overflow: hidden;
              cursor: pointer;
              transition: all 0.3s ease;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
              position: relative;
              background: #f0f0f0;
            }
            .timeline-photo:hover {
              transform: translateY(-3px);
              box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            }
            .timeline-photo img {
              width: 100%;
              height: 100%;
              object-fit: cover;
              transition: transform 0.3s ease;
            }
            .photo-overlay {
              position: absolute;
              bottom: 0;
              left: 0;
              right: 0;
              background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
              color: white;
              padding: 10px 8px 6px;
              font-size: 11px;
              font-weight: 600;
              text-align: center;
            }

      /* Source Indicator Dot (Grid View) */
            .source-dot {
              position: absolute;
              top: 6px;
              left: 6px;
              width: 10px;  /* Slightly larger for visibility */
              height: 10px;
              border-radius: 50%;
              box-shadow: 0 1px 3px rgba(0,0,0,0.5);
              z-index: 2;
              border: 1px solid rgba(255,255,255,0.9);
            }

            /* Source Colors (Affects both Dots and Badges) */
            .bg-weibo {
                background: #B8860B; /* Gold */
                color: #fff;         /* Black text for Modal Badge */
            }
            .bg-oasis {
                background: #2CB353; /* Green */
                color: #fff;         /* White text */
            }
            .bg-ins {
                background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584, #E1306C, #FD1D1D);
                color: #fff;
            }


      .bg-douyin {
          background: #000000;
          color: #fff;
      }

            /* Modal Styles */
            .modal {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0, 0, 0, 0.9);
              display: flex;
              align-items: center;
              justify-content: center;
              z-index: 1000;
              padding: 5px;
              overflow: hidden;
            }
            .modal-content {
              background: white;
              border-radius: 15px;
              max-width: 700px;
              max-height: 90vh;
              width: 100%;
              height: auto;
              position: relative;
              display: flex;
              flex-direction: column;
              overflow-y: auto;
              overflow-x: hidden;
            }
            .modal-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 8px 10px;
              border-bottom: 1px solid #e0e0e0;
              background: #f8f9fa;
              border-radius: 15px 15px 0 0;
              flex-shrink: 0;
            }
            .group-title {
              font-weight: 600;
              color: #333;
              font-size: 14px;
              flex: 1;
              text-align: center;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
            }
      .source-badge {
        font-size: 11px;       /* Slightly larger for readability */
        padding: 4px 10px;
        border-radius: 12px;   /* Pill shape looks more modern */
        color: white;
        font-weight: 700;
        text-transform: uppercase;
        white-space: nowrap;   /* Forces text to stay on one line */
        letter-spacing: 0.5px;
      }

            .photo-counter {
              font-weight: 600;
              color: #5E9FD8;
              font-size: 12px;
              min-width: 60px;
            }
            .close-modal {
              background: none;
              border: none;
              font-size: 30px;
              cursor: pointer;
              color: #333;
              padding: 0 10px;
              transition: color 0.3s;
            }
            .modal-photo-container {
              flex: 1 1 auto;
              display: flex;
              align-items: center;
              justify-content: center;
              position: relative;
              overflow: hidden;
              background: #000;
              min-height: 350px;
              max-height: 60vh;
              height: 60vh;
            }
            .modal-photo {
              max-width: 100%;
              max-height: 100%;
              width: auto;
              height: auto;
              object-fit: contain;
            }

            .modal-tag-pill {
              font-size: 11px;
              padding: 4px 12px;
              background-color: #f0f2f5;
              color: #555;
              border-radius: 15px;
              border: 1px solid #e4e6eb;
              white-space: nowrap;
              transition: all 0.2s ease;
            }

            /* Nav Arrows */
            .nav-arrow {
              position: absolute;
              top: 50%;
              transform: translateY(-50%);
              background: rgba(255, 255, 255, 0.9);
              border: none;
              width: 50px;
              height: 50px;
              border-radius: 50%;
              cursor: pointer;
              font-size: 18px;
              font-weight: bold;
              color: #333;
              z-index: 10;
              display: flex;
              align-items: center;
              justify-content: center;
            }
            .nav-arrow.prev {
              left: 20px;
            }
            .nav-arrow.next {
              right: 20px;
            }

            /* Thumb Strip */
            .thumbnail-strip {
              padding: 15px 20px;
              background: #f8f9fa;
              border-top: 1px solid #e0e0e0;
              overflow-x: auto;
              white-space: nowrap;
              border-radius: 0 0 15px 15px;
              min-height: 80px;
              flex-shrink: 0;
            }
            .thumbnail-container {
              display: inline-flex;
              gap: 10px;
            }
            .thumbnail {
              width: 50px;
              height: 50px;
              object-fit: cover;
              border-radius: 8px;
              cursor: pointer;
              border: 2px solid transparent;
              flex-shrink: 0;
            }
            .thumbnail.active {
              border-color: #5E9FD8;
              box-shadow: 0 0 0 2px rgba(94, 159, 216, 0.3);
            }

            /* Info Panel */
            .photo-info-panel {
              padding: 8px 10px;
              background: white;
              border-top: 1px solid #e0e0e0;
              flex-shrink: 0;
            }
            .download-actions-row {
              display: flex;
              gap: 10px;
              justify-content: center;
              flex-wrap: wrap;
              margin-top: 5px;
            }
            .action-btn {
              flex: 1;
              min-width: 160px;
              max-width: 200px;
              padding: 8px 10px;
              border: none;
              border-radius: 8px;
              font-size: 12px;
              font-weight: 600;
              cursor: pointer;
              text-decoration: none;
              text-align: center;
              color: white;
              display: inline-block;
            }
            .download-btn {
              background: linear-gradient(45deg, #4caf50, #45a049);
            }
            .source-link-btn {
              background: linear-gradient(45deg, #5E9FD8, #4A8BC8);
            }

            /* Footer */
            .site-footer {
              background: linear-gradient(135deg, #1F2937 0%, #2D3748 100%);
              color: white;
              padding: 10px 0;
              margin-top: 50px;
              text-align: center;
              font-size: 0.8rem;
            }
            .footer-content {
              margin-bottom: 10px;
            }
            .footer-link {
              color: white;
              text-decoration: underline;
              font-weight: 600;
              display: inline-block;
              padding: 8px 12px;
              border-radius: 8px;
              transition: all 0.3s ease;
              margin: 0 8px;
            }
            .footer-link:hover {
              opacity: 0.9;
              transform: translateY(-1px);
              background: rgba(255, 255, 255, 0.1);
            }
            #terms-content {
              background-color: rgba(255, 255, 255, 0.1);
              border-radius: 10px;
              margin: 15px auto 0;
              text-align: left;
              max-width: 700px;
              padding: 15px 20px;
              display: none;
            }
            #terms-content ul {
              list-style: disc;
              padding-left: 20px;
              margin: 10px 0;
            }
            #terms-content li {
              margin: 5px 0;
            }
            .copyright-notice {
              opacity: 0.9;
              margin-top: 10px;
              font-size: 0.8rem;
            }

            /* Pagination & Loading */
            .pagination-nav {
              display: flex;
              justify-content: center;
              align-items: center;
              gap: 8px;
              flex-wrap: wrap;
              margin-top: 20px;
            }
            .pagination-nav .btn {
              min-width: 40px;
              padding: 8px 12px;
              font-size: 13px;
              background: rgba(94, 159, 216, 0.1);
              color: #5E9FD8;
              border: 1px solid #5E9FD8;
              border-radius: 8px;
              cursor: pointer;
              text-decoration: none;
              display: inline-block;
              font-weight: 600;
            }
            .pagination-nav .btn:hover {
              background: rgba(94, 159, 216, 0.2);
              transform: translateY(-2px);
            }
            .pagination-nav .btn.primary,
            .pagination-nav .btn[disabled] {
              background: linear-gradient(45deg, #5E9FD8, #4A8BC8);
              color: white;
              transform: none;
              cursor: default;
              border: none;
              opacity: 1;
              box-shadow: none;
            }
            .pagination-nav span {
              color: #555;
              padding: 0 5px;
              font-weight: 600;
            }

            /* Jump to Page Styles */
            .jump-to-page {
              display: flex;
              align-items: center;
              gap: 5px;
              margin-left: 15px;
            }
            .jump-to-page input {
              width: 70px;
              padding: 8px;
              border-radius: 8px;
              border: 1px solid #ccc;
              text-align: center;
              font-size: 13px;
              outline: none;
            }
            .jump-to-page input:focus {
              border-color: #5E9FD8;
            }

            #back-to-top {
              position: fixed;
              bottom: 20px;
              right: 20px;
              background: white;
              color: #5E9FD8;
              width: 80px;
              height: 90x;
              border-radius: 30px;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
              opacity: 0;
              visibility: hidden;
              transition: all 0.3s ease;
              z-index: 9999;
              border: 1px solid #5E9FD8;
              font-size: 40px;
              font-weight: 600;
              -webkit-text-stroke: 2px #5E9FD8;
              text-stroke: 2px #5E9FD8;
              padding: 4px 4px;
            }
            #back-to-top .arrow {
              line-height: 1;
            }
            #back-to-top .text {
              font-size: 12px;
              font-weight: 600;
              margin-top: 0px;
              text-align: center;
              line-height: 1;
              color: #5E9FD8;
              -webkit-text-stroke: 0;
              text-stroke: 0;
              -webkit-text-fill-color: #5E9FD8;
              position: relative;
              z-index: 1;
            }

            #back-to-top.visible {
              opacity: 0.85;
              visibility: visible;
              animation: subtle-pulse-white 2s infinite ease-in-out;
            }
            #back-to-top:hover {
              transform: scale(1.15);
              box-shadow: 0 6px 25px rgba(94, 159, 216, 0.4);
              opacity: 1;
            }

            @keyframes subtle-pulse-white {
              0%, 100% { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); }
              50% { box-shadow: 0 4px 20px rgba(94, 159, 216, 0.3); }
            }

            /* Mobile Responsiveness */
      @media (min-width: 769px) {
        .source-filters {
          flex-wrap: nowrap;     /* FORCE single line */
          white-space: nowrap;   /* Prevent text inside creating weird breaks */
          padding: 10px 25px;    /* More breathing room on big screens */
          width: auto;           /* Let it grow naturally */
          max-width: 900px;      /* Ensure it doesn't get absurdly wide */
        }

      /* Optional: Ensure pills don't shrink too much */
        .source-pill {
          flex-shrink: 0;
          min-width: 100px;      /* Ensure buttons feel substantial on desktop */
        }
      }


            @media (max-width: 768px) {
              .container { padding: 15px; }
              .nav-buttons { gap: 15px; }
              .nav-btn { padding: 10px 12px; font-size: 13px; }
              .year-photos-grid { grid-template-columns: repeat(3, 1fr); gap: 8px; }
              .stats-grid { grid-template-columns: repeat(3, 1fr); gap: 8px; }

              .modal { padding: 5px; align-items: flex-start; padding-top: 5px; }
              .modal-content { max-width: 95vw; max-height: 98vh; margin-top: 0; }
              .modal-photo-container { flex: none; height: 35vh; min-height: 200px; max-height: 300px; }
              .nav-arrow { width: 40px; height: 40px; font-size: 16px; }
              .thumbnail-strip { padding: 8px 10px; min-height: 50px; }
              .thumbnail { width: 40px; height: 40px; }
              .close-modal { font-size: 40px; }

              /* Mobile filter adjustments */
      .source-filters {
          border-radius: 15px;
          padding: 8px 10px;
          width: 100%;       /* Fill width on mobile */
        }

        /* Optional: Hide the text label on very small screens to save space */
        .filter-label {
          display: none;
        }
      }

              .source-pill {flex: 1 1 30%; max-width: 45%; font-size: 11px; padding: 6px 4px; height: 44px;}
            }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Xiao Zhan Social Media Archive<br />ËÇñÊàòÁ§æ‰∫§Â™í‰ΩìÂ≠òÊ°£</h1>
        <p
          class="subtitle"
          style="font-weight: 600; color: white; line-height: 1.8"
        >
          * Archive of Social Media Posts by Xiao Zhan<br />
          *
          <a
            href="https://xz-studio-gallery.com/"
            target="_blank"
            style="color: white; text-decoration: underline"
            >Click here for XZ Studio Gallery ËÇñÊàòÂ∑•‰ΩúÂÆ§È´òÊ∏ÖÂõæÂ∫ì</a
          ><br />
          <a
            href="https://canadaxfx.github.io/XZ-HD-Gallery-Misc/"
            target="_blank"
            style="color: white; text-decoration: underline"
            >Click here for XZ HD Gallery Misc ËÇñÊàòÈ´òÊ∏ÖÂõæÂ∫ì-ÂÖ∂‰ªñ</a
          ><br />
        </p>
      </header>

      <nav class="nav-buttons">
        <button
          class="nav-btn active"
          data-section="screenshot"
          onclick="switchTab('screenshot')"
        >
          Post Screenshots<br />Á§æ‰∫§Âπ≥Âè∞Êà™Âõæ
        </button>
        <button
          class="nav-btn"
          data-section="attached"
          onclick="switchTab('attached')"
        >
          Attached Visual Media<br />ÈÖçÂõæ&ËßÜÈ¢ë
        </button>
      </nav>

      <div class="source-filters" id="sourceFilters">
        <span class="filter-label">Filter:</span>

        <div class="source-pill active" onclick="filterBySource('all', this)">
          All Sources<br />ÂÖ®ÈÉ®
        </div>
        <div class="source-pill" onclick="filterBySource('weibo', this)">
          Weibo<br />ÂæÆÂçö
        </div>
        <div class="source-pill" onclick="filterBySource('oasis', this)">
          Oasis<br />ÁªøÊ¥≤
        </div>
        <div class="source-pill" onclick="filterBySource('douyin', this)">
          Douyin<br />ÊäñÈü≥
        </div>
        <div class="source-pill" onclick="filterBySource('ins', this)">
          Instagram
        </div>
      </div>

      <div class="content-section">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="totalPhotosDisplay">0</div>
            <div class="stat-label">Items</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="yearsSpanDisplay">0</div>
            <div class="stat-label">Years</div>
          </div>
        </div>

        <div class="date-filter-container">
          <div class="date-select-wrapper">
            <select id="filterYear" onchange="applyDateFilter()">
              <option value="all">Year: All</option>
            </select>

            <select id="filterMonth" onchange="applyDateFilter()">
              <option value="all">Month</option>
              <option value="01">1Êúà Jan</option>
              <option value="02">2Êúà Feb</option>
              <option value="03">3Êúà Mar</option>
              <option value="04">4Êúà Apr</option>
              <option value="05">5Êúà May</option>
              <option value="06">6Êúà Jun</option>
              <option value="07">7Êúà Jul</option>
              <option value="08">8Êúà Aug</option>
              <option value="09">9Êúà Sep</option>
              <option value="10">10Êúà Oct</option>
              <option value="11">11Êúà Nov</option>
              <option value="12">12Êúà Dec</option>
            </select>

            <select id="filterDay" onchange="applyDateFilter()">
              <option value="all">Day</option>
            </select>
          </div>

          <button
            class="reset-date-btn hidden"
            id="resetDateBtn"
            onclick="resetDateFilter()"
          >
            ‚úï
          </button>
        </div>

        <input
          type="text"
          class="search-bar"
          placeholder="Search by keywords ÂÖ≥ÈîÆËØçÊêúÁ¥¢"
          id="searchInput"
        />
        <button
          class="btn primary hidden"
          id="clearSearchBtn"
          onclick="clearSearch()"
          style="display: block; margin: 0 auto 20px; max-width: 400px"
        >
          Clear Search / ËøîÂõû
        </button>

        <div id="timelineContainer" class="timeline-container">
          <div class="timeline-empty">
            <h3>Loading Archive...</h3>
            <p>Organizing items by year.</p>
          </div>
        </div>
      </div>
    </div>

    <div id="photoModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <div class="photo-counter" id="photoCounter">1 / 1</div>
          <div class="group-title">
            <span id="groupTitleDate"></span>
            <span id="modalSourceBadge" class="source-badge"></span>
          </div>
          <button class="close-modal" onclick="closeModal()">&times;</button>
        </div>

        <div class="modal-photo-container">
          <button class="nav-arrow prev" onclick="navigatePhoto(-1)">‚Äπ</button>
          <img id="modalPhoto" class="modal-photo" alt="Current photo" />
          <video
            id="modalVideo"
            class="modal-photo hidden"
            controls
            playsinline
            loop
          ></video>
          <button class="nav-arrow next" onclick="navigatePhoto(1)">‚Ä∫</button>
        </div>

        <div class="thumbnail-strip">
          <div class="thumbnail-container" id="thumbnailContainer"></div>
        </div>

        <div class="photo-info-panel">
          <div
            id="modalTags"
            style="
              display: flex;
              flex-wrap: wrap;
              gap: 8px;
              justify-content: center;
              margin-bottom: 15px;
              padding: 0 5px;
            "
          ></div>
          <div class="download-actions-row">
            <a
              class="action-btn download-btn"
              id="downloadBtn"
              href="#"
              target="_blank"
              download
            >
              üíæ Download HD<br /><small>‰∏ãËΩΩÂéüÂõæ</small>
            </a>
            <a
              class="action-btn source-link-btn"
              id="sourceLinkBtn"
              target="_blank"
            >
              üîó View Original Post<br /><small>Êü•ÁúãÂéüË¥¥ (Ëã•ÂèØËßÅ)</small>
            </a>
          </div>
        </div>
      </div>
    </div>

    <div id="reportModal" class="modal hidden">
      <div class="modal-content" style="max-width: 500px">
        <button class="close-modal" onclick="closeReportModal()">
          &times;
        </button>
        <div class="report-form-container" style="padding: 10px">
          <div style="text-align: center; margin-bottom: 20px">
            <h3 style="color: #5E9FD8; margin-bottom: 10px">
              üîß Report an Issue
            </h3>
            <p style="color: #666; font-size: 14px">
              Help us by reporting bugs or broken links<br />
              <span style="font-size: 12px; color: #888"
                >Â∏ÆÂä©Êàë‰ª¨ÊîπËøõÁΩëÁ´ôÔºåÊä•ÂëäÈîôËØØÊàñÂ§±ÊïàÈìæÊé•</span
              >
            </p>
          </div>

          <form
            id="reportForm"
            class="report-form"
            action="https://formsubmit.co/canadaxfx1005@gmail.com"
            method="POST"
          >
            <input type="text" name="_honey" style="display: none" />
            <input type="hidden" name="_captcha" value="true" />
            <input
              type="hidden"
              name="_next"
              value="https://canadaxfx.github.io/XZ-social-media-archive/report-success.html"
            />
            <input
              type="hidden"
              name="_subject"
              value="XZ Archive Issue Report"
            />

            <div style="margin-bottom: 10px">
              <label
                for="reportType"
                style="
                  display: block;
                  font-size: 13px;
                  font-weight: 600;
                  color: #444;
                  margin-bottom: 5px;
                "
                >Issue Type ÈóÆÈ¢òÁ±ªÂûã</label
              >
              <select
                id="reportType"
                name="issue_type"
                required
                style="
                  padding: 5px;
                  border: 1px solid #ccc;
                  border-radius: 8px;
                  font-size: 14px;
                  width: 100%;
                "
              >
                <option value="">Select issue type...</option>
                <option value="broken-link">Broken Link ÈìæÊé•Â§±Êïà</option>
                <option value="missing-photo">Missing Photo ÂõæÁâá‰∏¢Â§±</option>
                <option value="download-issue">
                  Download Problem ‰∏ãËΩΩÈóÆÈ¢ò
                </option>
                <option value="page-error">Page Error È°µÈù¢ÈîôËØØ</option>
                <option value="feature-request">
                  Feature Request ÂäüËÉΩÂª∫ËÆÆ
                </option>
                <option value="other">Other ÂÖ∂‰ªñ</option>
              </select>
            </div>

            <div style="margin-bottom: 10px">
              <label
                for="reportPage"
                style="
                  display: block;
                  font-size: 13px;
                  font-weight: 600;
                  color: #444;
                  margin-bottom: 5px;
                "
                >Page/Section È°µÈù¢/ÈÉ®ÂàÜ</label
              >
              <input
                type="text"
                id="reportPage"
                name="page_section"
                placeholder="e.g., 2024 photos, Game section, etc."
                required
                style="
                  padding: 5px;
                  border: 1px solid #ccc;
                  border-radius: 8px;
                  font-size: 14px;
                  width: 100%;
                "
              />
            </div>

            <div style="margin-bottom: 10px">
              <label
                for="reportDevice"
                style="
                  display: block;
                  font-size: 13px;
                  font-weight: 600;
                  color: #444;
                  margin-bottom: 5px;
                "
                >Device & Browser ËÆæÂ§áÂíåÊµèËßàÂô®</label
              >
              <input
                type="text"
                id="reportDevice"
                name="device_browser"
                placeholder="Auto-detected..."
                style="
                  padding: 5px;
                  border: 1px solid #ccc;
                  border-radius: 8px;
                  font-size: 14px;
                  width: 100%;
                "
              />
            </div>

            <div style="margin-bottom: 10px">
              <label
                for="reportDescription"
                style="
                  display: block;
                  font-size: 13px;
                  font-weight: 600;
                  color: #444;
                  margin-bottom: 5px;
                "
                >Description ËØ¶ÁªÜÊèèËø∞</label
              >
              <textarea
                id="reportDescription"
                name="description"
                rows="4"
                placeholder="Please describe the issue in detail..."
                required
                style="
                  padding: 5px;
                  border: 1px solid #ccc;
                  border-radius: 8px;
                  font-size: 14px;
                  width: 100%;
                "
              ></textarea>
            </div>

            <div style="margin-bottom: 10px">
              <label
                for="reportEmail"
                style="
                  display: block;
                  font-size: 13px;
                  font-weight: 600;
                  color: #444;
                  margin-bottom: 5px;
                "
                >Your Email (Optional) ÈÇÆÁÆ±ÔºàÂèØÈÄâÔºâ</label
              >
              <input
                type="email"
                id="reportEmail"
                name="user_email"
                placeholder="your@email.com (for follow-up)"
                style="
                  padding: 10px;
                  border: 1px solid #ccc;
                  border-radius: 8px;
                  font-size: 14px;
                  width: 100%;
                "
              />
            </div>

            <div
              class="form-actions"
              style="
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                margin-top: 10px;
                padding-top: 10px;
                border-top: 1px solid #eee;
              "
            >
              <button
                type="button"
                class="nav-btn"
                style="background: #f8f8f8; color: #666; border: 1px solid #ddd"
                onclick="closeReportModal()"
              >
                Cancel ÂèñÊ∂à
              </button>
              <button type="submit" class="btn primary">
                Send Report ÂèëÈÄÅÊä•Âëä
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="back-to-top">
      <div class="arrow">‚ñ≤</div>
      <div class="text">TOP<br />ÂõûÈ°∂ÈÉ®</div>
    </div>

    <footer class="site-footer">
      <div class="footer-content">
        <div style="margin-bottom: 10px; font-weight: 700">Explore more</div>
        <a
          class="footer-link"
          href="https://canadaxfx.github.io/XZworks/"
          target="_blank"
          >Screen Arts of Xiao Zhan</a
        >
        <a
          class="footer-link"
          href="https://www.youtube.com/@CanadaXFX"
          target="_blank"
          >CanadaXFX YouTube Channel</a
        >
      </div>

      <div
        class="footer-content"
        style="
          margin-top: 20px;
          padding-top: 10px;
          border-top: 1px solid rgba(255, 255, 255, 0.2);
        "
      >
        <a
          class="footer-link"
          href="#"
          onclick="openReportModal(); return false;"
        >
          üîß Report Broken Links or Bugs<br />
          <small style="font-size: 11px; opacity: 0.8; font-weight: normal"
            >Êä•ÂëäÈîôËØØÈìæÊé•ÊàñÂäüËÉΩÈóÆÈ¢ò</small
          >
        </a>
      </div>

      <div class="copyright-notice">
        &copy; 2025 CanadaXFX. All rights reserved.
      </div>

      <a href="#" id="terms-toggle" class="footer-link">Terms of Use</a>
      <div id="terms-content">
        <ul>
          <li>
            All images and content related to Xiao Zhan belong to their
            respective copyright owners.
          </li>
          <li>
            All content on this site is curated and organized ¬© 2025 CanadaXFX.
          </li>
          <li>AI training is strictly prohibited.</li>
          <li>
            The original content, design, and code of this website may not be
            reproduced, distributed, or used without explicit permission.
          </li>
          <li>Personal and non-commercial use only.</li>
        </ul>
      </div>
    </footer>

    <script>
      // --- VARIABLES ---
      let allData = [];
      let categoryData = [];
      let activeData = [];
      let currentRenderData = [];
      let currentTab = "screenshot";
      let currentSourceFilter = "all";
      let expandedYears = new Set();
      let paginationState = {};
      let imageObserver = null;
      let currentGroupPhotos = [];
      let currentPhotoIndex = 0;

      // --- SETUP ---
      document.addEventListener("DOMContentLoaded", () => {
        loadAllData();
        setupIntersectionObserver();
        setupSearch();
        setupBackToTop();
        setupFooterToggle();
        setupDateFilters();
      });

      // --- DATA LOADING & TABS ---
      async function loadAllData() {
        // Files array remains the same
        const files = [
          2026, 2025, 2024, 2023, 2022, 2021, 2020, 2019, 2018, 2017, 2016,
          2015,
        ];
        let combined = [];

        for (let f of files) {
          try {
            const res = await fetch(`${f}.json?v=${Date.now()}`);
            if (res.ok) {
              const json = await res.json();
              if (Array.isArray(json)) combined.push(...json);
            }
          } catch (e) {
            console.log(`Skipped ${f}.json`);
          }
        }

        // --- PROCESSING DATA ---
        combined.forEach((item, idx) => {
          item._uid = idx;
          if (item.date && item.date.length >= 4) {
            item.year = item.date.substring(0, 4);
          }
          // NEW: Default source to 'weibo' if missing
          if (!item.source) {
            item.source = "weibo";
          }
        });

        combined.sort((a, b) => b.date.localeCompare(a.date));
        allData = combined;

        const years = [...new Set(allData.map((d) => d.year))].sort().reverse();
        const yearSelect = document.getElementById("filterYear");
        yearSelect.innerHTML = '<option value="all">Year: All</option>';
        years.forEach((y) => {
          let opt = document.createElement("option");
          opt.value = y;
          opt.innerText = y;
          yearSelect.appendChild(opt);
        });

        switchTab("screenshot");
      }

      function switchTab(tabName) {
        currentTab = tabName;
        // Update UI Tabs
        document.querySelectorAll(".nav-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.section === tabName);
        });

        // 1. Filter by Category first
        if (tabName === "screenshot") {
          categoryData = allData.filter(
            (item) => item.category === "screenshot",
          );
        } else {
          categoryData = allData.filter(
            (item) => item.category === "attached" || !item.category,
          );
        }

        // 2. Reset or Re-apply Source Filter?
        // Better UX to keep the source filter active if user selected one
        applyFilters();
      }

      function filterBySource(source, element) {
        currentSourceFilter = source;

        // Update Pill UI
        document
          .querySelectorAll(".source-pill")
          .forEach((el) => el.classList.remove("active"));
        element.classList.add("active");

        applyFilters();
      }

      function applyFilters() {
        // Filter categoryData based on currentSourceFilter
        if (currentSourceFilter === "all") {
          activeData = [...categoryData];
        } else {
          activeData = categoryData.filter(
            (item) => item.source === currentSourceFilter,
          );
        }

        // --- ADD THIS LINE ---
        currentRenderData = [...activeData]; // Sync render data with active filters
        // ---------------------

        expandedYears.clear();
        paginationState = {};
        document.getElementById("searchInput").value = "";
        updateStats();
        renderTimeline();

        if (activeData.length > 0) {
          const years = [...new Set(activeData.map((d) => d.year))]
            .sort()
            .reverse();
          if (years.length) toggleYear(years[0]);

          if (
            document.getElementById("filterYear").value !== "all" ||
            document.getElementById("filterMonth").value !== "all" ||
            document.getElementById("filterDay").value !== "all"
          ) {
            applyDateFilter();
          }
        }
      }

      function clearSearch() {
        const input = document.getElementById("searchInput");
        input.value = "";
        document.getElementById("clearSearchBtn").classList.add("hidden");
        paginationState = {};
        renderTimeline(activeData);
      }

      function setupDateFilters() {
        // Populate Day Dropdown (1-31)
        const daySelect = document.getElementById("filterDay");
        for (let i = 1; i <= 31; i++) {
          let val = i < 10 ? "0" + i : i;
          let opt = document.createElement("option");
          opt.value = val;
          opt.innerText = val;
          daySelect.appendChild(opt);
        }
      }

      function applyDateFilter() {
        const yVal = document.getElementById("filterYear").value;
        const mVal = document.getElementById("filterMonth").value;
        const dVal = document.getElementById("filterDay").value;
        const resetBtn = document.getElementById("resetDateBtn");

        // Show reset button if any filter is active
        if (yVal !== "all" || mVal !== "all" || dVal !== "all") {
          resetBtn.classList.remove("hidden");
        } else {
          resetBtn.classList.add("hidden");
        }

        // Start with the currently active source/category data (activeData is set by Source Filters)
        // Note: We need to make sure we don't lose the Category/Source selection.
        // The easiest way is to re-run the main filter chain, but let's filter 'activeData' locally for now
        // assuming 'activeData' contains the correct Category + Source items.

        // HOWEVER, to be safe, let's filter against 'activeData' which holds (Category + Source) results.
        let filtered = activeData.filter((item) => {
          // item.date format is typically "YYYY-MM-DD..."

          // 1. Check Year
          if (yVal !== "all" && item.year !== yVal) return false;

          // 2. Check Month (The month is index 5-7 in "2025-05-11")
          if (mVal !== "all") {
            // Safety check if date string is long enough
            if (!item.date || item.date.length < 7) return false;
            const itemMonth = item.date.substring(5, 7);
            if (itemMonth !== mVal) return false;
          }

          // 3. Check Day (The day is index 8-10 in "2025-05-11")
          if (dVal !== "all") {
            if (!item.date || item.date.length < 10) return false;
            const itemDay = item.date.substring(8, 10);
            if (itemDay !== dVal) return false;
          }

          return true;
        });

        // Update global render data and refresh timeline
        currentRenderData = filtered;

        // Clear text search input to avoid confusion
        document.getElementById("searchInput").value = "";
        document.getElementById("clearSearchBtn").classList.add("hidden");

        renderTimeline(filtered);
      }

      function resetDateFilter() {
        document.getElementById("filterYear").value = "all";
        document.getElementById("filterMonth").value = "all";
        document.getElementById("filterDay").value = "all";
        applyDateFilter(); // Re-runs filter, which resets to full list
      }

      // --- RENDERING (Timeline & Pagination) ---
      // (Keep creatingPaginationHTML function exactly as is from previous version)
      function createPaginationHTML(year, currentPage, totalPages) {
        let html = "";
        const maxPagesToShow = 5;
        let startPage, endPage;

        if (totalPages <= maxPagesToShow) {
          startPage = 1;
          endPage = totalPages;
        } else {
          const maxBefore = Math.floor(maxPagesToShow / 2);
          const maxAfter = Math.ceil(maxPagesToShow / 2) - 1;
          if (currentPage <= maxBefore) {
            startPage = 1;
            endPage = maxPagesToShow;
          } else if (currentPage + maxAfter >= totalPages) {
            startPage = totalPages - maxPagesToShow + 1;
            endPage = totalPages;
          } else {
            startPage = currentPage - maxBefore;
            endPage = currentPage + maxAfter;
          }
        }
        if (currentPage > 1) {
          html += `<button class="btn" onclick="goToPage('${year}', ${currentPage - 1})">‚Äπ Prev</button>`;
        } else {
          html += `<button class="btn" disabled>‚Äπ Prev</button>`;
        }
        if (startPage > 1) {
          html += `<button class="btn" onclick="goToPage('${year}', 1)">1</button>`;
          if (startPage > 2) html += `<span>...</span>`;
        }
        for (let i = startPage; i <= endPage; i++) {
          const isCurrent = i === currentPage;
          html += `<button class="btn ${isCurrent ? "primary" : ""}" ${isCurrent ? "disabled" : `onclick="goToPage('${year}', ${i})"`}>${i}</button>`;
        }
        if (endPage < totalPages) {
          if (endPage < totalPages - 1) html += `<span>...</span>`;
          html += `<button class="btn" onclick="goToPage('${year}', ${totalPages})">${totalPages}</button>`;
        }
        if (currentPage < totalPages) {
          html += `<button class="btn" onclick="goToPage('${year}', ${currentPage + 1})">Next ‚Ä∫</button>`;
        } else {
          html += `<button class="btn" disabled>Next ‚Ä∫</button>`;
        }
        html += `<div class="jump-to-page"><input type="number" min="1" max="${totalPages}" placeholder="#" onkeypress="if(event.key==='Enter') goToPage('${year}', this.value)"><button class="btn" onclick="goToPage('${year}', this.previousElementSibling.value)">Go</button></div>`;
        return html;
      }

      function renderTimeline(dataToRender = activeData) {
        const container = document.getElementById("timelineContainer");
        if (dataToRender.length === 0) {
          container.innerHTML = `<div class="timeline-empty"><h3>No Items Found</h3><p>Try different filters.</p></div>`;
          return;
        }

        const grouped = dataToRender.reduce((acc, item) => {
          if (!acc[item.year]) acc[item.year] = [];
          acc[item.year].push(item);
          return acc;
        }, {});

        const sortedYears = Object.keys(grouped).sort((a, b) => b - a);

        container.innerHTML = sortedYears
          .map((year) => {
            const items = grouped[year];
            const count = items.length;
            const previewHtml = items
              .slice(0, 4)
              .map(
                (p) =>
                  `<img src="${getThumbUrl(p.url)}" class="preview-thumb">`,
              )
              .join("");
            const isExpanded = expandedYears.has(year);
            const photoUids = items.map((item) => item._uid).join(",");

            return `
                    <div class="timeline-year ${isExpanded ? "expanded" : ""}" data-year="${year}">
                        <div class="timeline-year-header" onclick="toggleYear('${year}')">
                            <div class="year-header-content">
                                <div class="year-header-top">
                                    <span class="year-title">${year}</span>
                                    <div style="display:flex; align-items:center; gap:10px;">
                                        <span class="timeline-year-count">${count} items</span>
                                        <span class="expand-icon">‚ñº</span>
                                    </div>
                                </div>
                                <div class="year-preview">${previewHtml}</div>
                            </div>
                        </div>
                        <div class="timeline-year-content" data-photo-uids="${photoUids}">
                            <div class="year-controls">
                                <select onchange="changePerPage('${year}', this.value)">
                                    <option value="21">21 / page</option>
                                    <option value="42">42 / page</option>
                                    <option value="all">Show All</option>
                                </select>
                            </div>
                            <div class="year-photos-grid" id="grid-${year}"></div>
                            <div class="pagination-nav" id="nav-${year}"></div>
                        </div>
                    </div>`;
          })
          .join("");

        sortedYears.forEach((y) => {
          if (expandedYears.has(y)) {
            renderYearContent(y, grouped[y]);
          }
        });
      }

      function toggleYear(year) {
        const el = document.querySelector(
          `.timeline-year[data-year="${year}"]`,
        );
        if (!el) return;
        if (expandedYears.has(year)) {
          expandedYears.delete(year);
          el.classList.remove("expanded");
        } else {
          expandedYears.add(year);
          el.classList.add("expanded");
          const contentEl = el.querySelector(".timeline-year-content");
          const uidsString = contentEl.dataset.photoUids;
          let itemsToRender = null;
          if (uidsString) {
            const uids = uidsString.split(",").map((u) => parseInt(u, 10));
            itemsToRender = activeData.filter((item) =>
              uids.includes(item._uid),
            );
          }
          renderYearContent(year, itemsToRender);
        }
        updateStats();
      }

      function renderYearContent(year, itemsToRender = null) {
        const items =
          itemsToRender || currentRenderData.filter((i) => i.year == year);
        const state = paginationState[year] || { page: 1, limit: 21 };
        paginationState[year] = state;
        const grid = document.getElementById(`grid-${year}`);
        const nav = document.getElementById(`nav-${year}`);

        let displayItems = items;
        let totalPages = 1;
        if (state.limit !== "all") {
          const limit = parseInt(state.limit);
          totalPages = Math.ceil(items.length / limit);
          const start = (state.page - 1) * limit;
          displayItems = items.slice(start, start + limit);
        }

        // NEW: Add source dot color
        grid.innerHTML = displayItems
          .map((item) => {
            const isVideo = item.url.match(/\.(mp4|mov)$/i);

            // 1. Assign Color Class
            let dotClass = "bg-weibo"; // Default (Gold)
            let sourceName = "Weibo"; // Tooltip text

            if (item.source === "oasis") {
              dotClass = "bg-oasis";
              sourceName = "Oasis";
            } else if (item.source === "ins") {
              dotClass = "bg-ins";
              sourceName = "Instagram";
            } else if (item.source === "douyin") {
              dotClass = "bg-douyin";
              sourceName = "Douyin";
            }

            return `
    <div class="timeline-photo" onclick="openModal(${item._uid})">
        <div class="source-dot ${dotClass}" title="Source: ${sourceName}"></div>
        
        ${isVideo ? '<div class="video-overlay-icon">‚ñ∂</div>' : ""}
        
        <img data-src="${getThumbUrl(item.url)}" class="lazy-image loading-placeholder">
        <div class="photo-overlay">${item.date}</div>
    </div>`;
          })
          .join("");

        if (state.limit !== "all" && totalPages > 1) {
          nav.innerHTML =
            `<div class="pagination-nav">` +
            createPaginationHTML(year, state.page, totalPages) +
            `</div>`;
        } else {
          nav.innerHTML = "";
        }
        observeImages();
      }

      function changePerPage(year, val) {
        paginationState[year] = { page: 1, limit: val };
        renderYearContent(year);
      }
      function goToPage(year, page) {
        const items = currentRenderData.filter((i) => i.year == year);
        const limit = parseInt(paginationState[year].limit);
        const max = Math.ceil(items.length / limit);
        page = Math.max(1, Math.min(page, max));
        paginationState[year].page = page;
        renderYearContent(year);
        document
          .getElementById(`grid-${year}`)
          .scrollIntoView({ behavior: "smooth", block: "start" });
      }
      function getThumbUrl(fullUrl) {
        if (fullUrl.includes("/full/"))
          return fullUrl
            .replace("/full/", "/thumbs/")
            .replace(/(\.[^.]+)$/, "_m.jpg");
        return fullUrl;
      }
      function updateStats() {
        document.getElementById("totalPhotosDisplay").textContent =
          activeData.length;
        document.getElementById("yearsSpanDisplay").textContent = new Set(
          activeData.map((d) => d.year),
        ).size;
      }
      function setupIntersectionObserver() {
        imageObserver = new IntersectionObserver(
          (entries, obs) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.onload = () => img.classList.remove("loading-placeholder");
                obs.unobserve(img);
              }
            });
          },
          { rootMargin: "100px" },
        );
      }
      function observeImages() {
        document.querySelectorAll(".lazy-image").forEach((img) => {
          if (!img.src) imageObserver.observe(img);
        });
      }

      function setupSearch() {
        const input = document.getElementById("searchInput");
        const clearBtn = document.getElementById("clearSearchBtn");
        if (!input.value.trim()) {
          clearBtn.classList.add("hidden");
        }
        input.addEventListener("input", (e) => {
          const term = e.target.value.toLowerCase().trim();
          if (!term) {
            clearBtn.classList.add("hidden");
            currentRenderData = [...activeData];
            renderTimeline(activeData);
            return;
          }
          clearBtn.classList.remove("hidden");
          const filtered = activeData.filter(
            (item) =>
              (item.tags &&
                Array.isArray(item.tags) &&
                item.tags.some((t) => {
                  const lowerTag = t.toLowerCase();
                  const lowerTerm = term;
                  return (
                    lowerTag.includes(lowerTerm) || lowerTerm.includes(lowerTag)
                  );
                })) ||
              item.date.includes(term) ||
              (item.note && item.note.toLowerCase().includes(term)),
          );

          currentRenderData = filtered;

          renderTimeline(filtered);
        });
      }

      function setupBackToTop() {
        const btn = document.getElementById("back-to-top");
        if (!btn) return;
        window.addEventListener(
          "scroll",
          () => {
            window.requestAnimationFrame(() => {
              btn.classList.toggle("visible", window.scrollY > 300);
            });
          },
          { passive: true },
        );
        btn.addEventListener("click", () =>
          window.scrollTo({ top: 0, behavior: "smooth" }),
        );
      }

      // --- FOOTER FUNCTIONS ---
      function setupFooterToggle() {
        const termsToggle = document.getElementById("terms-toggle");
        if (!termsToggle) return;

        termsToggle.addEventListener("click", function (e) {
          e.preventDefault();
          const termsContent = document.getElementById("terms-content");

          // Check if currently hidden (inline style or computed style)
          const currentStyle = window.getComputedStyle(termsContent).display;
          const isHidden = currentStyle === "none";

          termsContent.style.display = isHidden ? "block" : "none";

          if (isHidden) {
            termsContent.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        });
      }

      // --- MODAL ---
      function openModal(uid) {
        const targetItem = activeData.find((i) => i._uid === uid);
        if (!targetItem) return;
        const groupKey =
          targetItem.groupName || targetItem.year + targetItem.month;
        currentGroupPhotos = activeData.filter((i) => {
          const itemKey = i.groupName || i.year + i.month;
          return itemKey === groupKey;
        });
        currentGroupPhotos.sort((a, b) => a.date.localeCompare(b.date));
        currentPhotoIndex = currentGroupPhotos.findIndex((i) => i._uid === uid);
        document.getElementById("photoModal").classList.remove("hidden");
        updateModalView();
        generateThumbnails();
        document.addEventListener("keydown", handleKeyNav);
      }

      function updateModalView() {
        const photo = currentGroupPhotos[currentPhotoIndex];
        if (!photo) return;
        const img = document.getElementById("modalPhoto");
        const vid = document.getElementById("modalVideo");
        const isVideo = photo.url.match(/\.(mp4|mov)$/i);
        if (isVideo) {
          img.classList.add("hidden");
          vid.classList.remove("hidden");
          vid.src = photo.url;
        } else {
          vid.classList.add("hidden");
          vid.pause();
          img.classList.remove("hidden");
          img.src = photo.url;
        }
        document.getElementById("photoCounter").textContent =
          `${currentPhotoIndex + 1} / ${currentGroupPhotos.length}`;

        // NEW: Update Badge and Title
        const dateEl = document.getElementById("groupTitleDate");
        dateEl.textContent = `${photo.date} - ${photo.groupName || ""}`;

        const badgeEl = document.getElementById("modalSourceBadge");
        badgeEl.className = "source-badge"; // reset classes
        if (photo.source === "oasis") {
          badgeEl.innerHTML = "OASIS ‚Ä¢ ÁªøÊ¥≤";
          badgeEl.classList.add("bg-oasis");
        } else if (photo.source === "ins") {
          badgeEl.innerHTML = "INSTAGRAM";
          badgeEl.classList.add("bg-ins");
        } else if (photo.source === "douyin") {
          badgeEl.innerHTML = "DOUYIN ‚Ä¢ ÊäñÈü≥";
          badgeEl.classList.add("bg-douyin");
        } else {
          badgeEl.innerHTML = "WEIBO ‚Ä¢ ÂæÆÂçö";
          badgeEl.classList.add("bg-weibo");
        }

        document.getElementById("downloadBtn").href = photo.url;
        const srcBtn = document.getElementById("sourceLinkBtn");

        // Use 'link' OR 'weibo' field
        const linkUrl = photo.link || photo.weibo;
        if (linkUrl) {
          srcBtn.href = linkUrl;
          srcBtn.style.display = "inline-block";
        } else {
          srcBtn.style.display = "none";
        }

        const tagsContainer = document.getElementById("modalTags");
        if (tagsContainer) {
          if (
            photo.tags &&
            Array.isArray(photo.tags) &&
            photo.tags.length > 0
          ) {
            tagsContainer.innerHTML = photo.tags
              .map((tag) => `<span class="modal-tag-pill">#${tag}</span>`)
              .join("");
            tagsContainer.style.display = "flex";
          } else {
            tagsContainer.style.display = "none";
          }
        }
        document
          .querySelectorAll(".thumbnail")
          .forEach((t, i) =>
            t.classList.toggle("active", i === currentPhotoIndex),
          );
        const activeThumb = document.querySelector(".thumbnail.active");
        if (activeThumb)
          activeThumb.scrollIntoView({ behavior: "smooth", inline: "center" });
      }

      function generateThumbnails() {
        document.getElementById("thumbnailContainer").innerHTML =
          currentGroupPhotos
            .map(
              (p, i) => `
            <img src="${getThumbUrl(p.url)}" class="thumbnail ${i === currentPhotoIndex ? "active" : ""}" onclick="jumpToPhoto(${i})">
        `,
            )
            .join("");
      }
      function navigatePhoto(dir) {
        const newIdx = currentPhotoIndex + dir;
        if (newIdx >= 0 && newIdx < currentGroupPhotos.length) {
          currentPhotoIndex = newIdx;
          updateModalView();
        }
      }
      function jumpToPhoto(idx) {
        currentPhotoIndex = idx;
        updateModalView();
      }
      function closeModal() {
        document.getElementById("photoModal").classList.add("hidden");
        document.getElementById("modalVideo").pause();
        document.removeEventListener("keydown", handleKeyNav);
      }
      function handleKeyNav(e) {
        if (e.key === "ArrowLeft") navigatePhoto(-1);
        if (e.key === "ArrowRight") navigatePhoto(1);
        if (e.key === "Escape") closeModal();
      }

      function closeReportModal() {
        document.getElementById("reportModal").classList.add("hidden");
        document.getElementById("reportForm").reset();
      }

      function openReportModal() {
        document.getElementById("reportModal").classList.remove("hidden");
        // Auto-detect user's device/browser info
        const deviceInfo = `${navigator.platform} - ${navigator.userAgent.split(" ").slice(-2).join(" ")}`;
        const deviceInput = document.getElementById("reportDevice");
        if (deviceInput) deviceInput.value = deviceInfo;
      }

      function closeReportModal() {
        document.getElementById("reportModal").classList.add("hidden");
        document.getElementById("reportForm").reset();
      }

      // Add click-outside listener for Report Modal
      document.getElementById("reportModal").addEventListener("click", (e) => {
        if (e.target === e.currentTarget) closeReportModal();
      });

      // (Keep setupFooterToggle and report functions if used in HTML)
    </script>
  </body>
</html>
